<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="color-scheme" content="dark light">
    <title>ðŸ¦ŠðŸ•’</title>
    <style>
      h1 {
        font-size: 15vw;
        margin: 0;
        text-align: center;
      }
      #time {
        font-family: monospace;
        font-size: 15vw;
        text-align: center;
        margin: 10px 0;
      }
      #status {
        font-family: sans-serif;
        position: fixed;
        bottom: 0;
      }
    </style>
  </head>
  <body>
    <h1 id="title">ðŸ¦ŠðŸ•’</h1>
    <p id="time"></p>
    <p id="status">
      RTT: <span id="delay">?</span>ms<br>
      Offset: <span id="offset">?</span>ms
    </p>
    <script type="module">
      const clockEmoji = ['ðŸ•›', 'ðŸ•§', 'ðŸ•', 'ðŸ•œ', 'ðŸ•‘', 'ðŸ•', 'ðŸ•’', 'ðŸ•ž',
        'ðŸ•“', 'ðŸ•Ÿ', 'ðŸ•”', 'ðŸ• ', 'ðŸ••', 'ðŸ•¡', 'ðŸ•–', 'ðŸ•£', 'ðŸ•—', 'ðŸ•¢', 'ðŸ•˜',
        'ðŸ•¤', 'ðŸ•™', 'ðŸ•¥', 'ðŸ•š', 'ðŸ•¦'];

      const delays = [];
      const offsets = [];
      let offset;

      function average(array) {
        return array.reduce((a, b) => a + b, 0) / array.length;
      }

      async function detectOffset() {
        const request_sent = Date.now();
        const server_time = Number(await (await fetch("/time")).text());
        const response_received = Date.now();

        const newDelay = response_received - request_sent;
        console.log(`Measured round-trip time of ${newDelay}ms.`);
        delays.push(newDelay);
        const delay = average(delays);
        document.getElementById('delay').textContent = delay;

        const newOffset = ((server_time - request_sent) + (server_time - response_received)) / 2;
        console.log(`Measured clock offset of ${newOffset}ms`);
        offsets.push(newOffset);
        offset = average(offsets);
        document.getElementById('offset').textContent = offset;

        if (offsets.length < 5) {
          setTimeout(detectOffset, 1000);
        }
      }

      function updateTime() {
        const now = new Date(Date.now() + offset);
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        const tenths = Math.floor(now.getMilliseconds() / 100).toString();
        document.getElementById('time').textContent = `${hours}:${minutes}:${seconds}.${tenths}`;

        const emojiIndex = (now.getHours() % 12) * 2 + Math.floor(now.getMinutes() / 30);
        const emoji = clockEmoji[emojiIndex];
        document.title = document.getElementById('title').textContent = `ðŸ¦Š${emoji}`;
        requestAnimationFrame(updateTime);
      }

      await detectOffset();
      updateTime();
      requestAnimationFrame(updateTime);
    </script>
  </body>
</html>
